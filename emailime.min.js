!function(e,t){"function"==typeof define&&define.amd?define(["./emailIME.css"],t):"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t():function(){throw new Error("emailIME requires a window with a document")}:t()}("undefined"!=typeof window?window:this,function(){var e,t;e="./emailIME.css",(t=document.createElement("link")).rel="stylesheet",t.type="text/css",t.href=e,document.getElementsByTagName("head")[0].appendChild(t);var d={addHandler:function(e,t,n){return e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n,{element:e,type:t,handler:n}},removeHandler:function(e,t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent?e.detachEvent("on"+t,n):e["on"+t]=null},getEvent:function(e){return e||window.event},getTarget:function(e){return e.target||e.srcElement},preventDefault:function(e){e.preventDefault?e.preventDefault():e.returnValue=!1},stopPropagation:function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0}};function a(e,t,n,i){this.id=e,this.itemListeners=t||[],this.inputListeners=n||[],this.separatorListeners=i||[]}function r(){}function n(){this.handlers={}}a.prototype={constructor:a,removeItemListener:function(){this.itemListeners.forEach(function(e){d.removeHandler(e.element,e.type,e.handler)}),this.itemListeners=[]},removeInputListener:function(){this.inputListeners.forEach(function(e){d.removeHandler(e.element,e.type,e.handler)}),this.inputListeners=[]},removeSeparatorListener:function(){this.separatorListeners.forEach(function(e){d.removeHandler(e.element,e.type,e.handler)}),this.separatorListeners=[]},removeAllListener:function(){this.removeSeparatorListener(),this.removeInputListener(),this.removeItemListener()}},(r.prototype=new Array).constructor=Array,r.prototype.filter=function(e){for(var t=new r,n=0,i=this.length;n<i;n++)e(this[n],n,this)&&t.push(this[n]);return t},r.prototype.indexOfId=function(e){for(var t=-1,n=0,i=this.length;n<i;n++)if(this[n].id===e){t=n;break}return t},n.prototype={constructor:n,addHandler:function(e,t){void 0===this.handlers[e]&&(this.handlers[e]=[]),this.handlers[e].push(t)},fire:function(e){if(e.target||(e.target=this),this.handlers[e.type]instanceof Array)for(var t=this.handlers[e.type],n=0,i=t.length;n<i;n++)t[n](e)},removeHandler:function(e,t){if(this.handlers[e]instanceof Array){for(var n=this.handlers[e],i=0,r=n.length;i<r&&n[i]!==t;i++);n.splice(i,i)}}};var i,o,l=(i=new n,o=null,i.enable=function(){d.addHandler(document,"mousedown",s),d.addHandler(document,"mousemove",s),d.addHandler(document,"mouseup",s)},i.disable=function(){d.removeHandler(document,"mousedown",s),d.removeHandler(document,"mousemove",s),d.removeHandler(document,"mouseup",s)},i);function s(e){e=d.getEvent(e);var t=d.getTarget(e);switch(e.type){case"mousedown":if(-1<t.className.indexOf("draggable")&&R(t)){if(0!==e.button)return;(o=document.createElement("div")).classList.add("virtualEl"),document.body.appendChild(o),i.fire({type:"dragstart",target:t})}break;case"mousemove":if(null!==o){if(0!==e.button)return;d.preventDefault(e),o.style.left=e.clientX+2+k.scrollLeft+"px",o.style.top=e.clientY+2+k.scrollTop+"px",o.style.display="block",i.fire({type:"drag",referEl:t,clientX:e.clientX,clientY:e.clientY})}break;case"mouseup":if(o){if(0!==e.button)return;i.fire({type:"dragend",referEl:t,x:e.clientX,y:e.clientY}),document.body.removeChild(o),d.stopPropagation(e)}o=null}}function c(e){return e.match(/^(?:\w+\.?)\w+@(?:\w+\.)+\w+$/)}function u(e,t){t=(t=t||e.value).replace(/[ ]/g,"&nbsp;"),K.innerHTML=t,e.style.fontSize=getComputedStyle(e)["font-size"],e.style.width=K.clientWidth+"px"}function f(e){var t=document.createElement("span");t.innerHTML=";",t.classList.add("semicolon"),t.classList.add("draggable"),e.appendChild(t)}function m(e,t,n){function i(e){return Number(e.split("px")[0])}for(var r,a=e.querySelectorAll(".inputClosed"),o=0,l=a.length;o<l;o++){var s=(r=a[o],cs=window.getComputedStyle?getComputedStyle(r,null):r.currentStyle,cs),d=a[o].getBoundingClientRect(),c=d.left,u=d.top,f=i(s.width),m=i(s.height),p=Number(s.marginLeft.split("px")[0]),h=Number(s.marginRight.split("px")[0]),d=Number(s.marginTop.split("px")[0]),s=Number(s.marginBottom.split("px")[0]);if(n<u-d){b(e,a[o],"before");break}if(n<=u+m+s){if(t<c-p){b(e,a[o],"before");break}if(t<=c+f+h){if(t<=c){b(e,a[o],"before");break}if(c+f<=t){b(e,a[o]);break}}else{if(!a[o+1]){b(e,a[o]);break}if(a[o+1].offsetTop>a[o].offsetTop){b(e,a[o]);break}}}else if(o===l-1){b(e);break}}0===a.length&&b(e),L()}function p(r){var a=r.parentNode,o=a.parentNode,i=G[G.indexOfId(a)];i.inputListeners.push(d.addHandler(r,"textInput",function(e){e=d.getEvent(e);var t=d.getTarget(e);u(r,t.value+e.data),t=t.value,/@/g.test(t)&&(t=e.data,/[,;，； ]/g.test(t))&&(d.preventDefault(e),s(r),h(o,a))}));var l,s=function(e){if(!J){if(J=!0,""===(n=e.value).trim())return a.classList.add("waitEdit"),e.nextSibling&&(i.removeSeparatorListener(),a.removeChild(e.nextSibling)),void(J=!1);e.nextSibling||f(a);var t=document.createElement("span"),n=n.replace(/[ ]/g,"");t.innerHTML=n,t.className="valueSpan draggable",i.removeInputListener(),a.replaceChild(t,e),c(n)?(a.classList.remove("error"),a.title=n):(a.classList.add("error"),a.title="该地址格式有误，请双击修改"),o.childNodes.forEach(function(t){t.getAttribute("addr")===n&&(G=G.filter(function(e){return e.id!==t||(e.removeAllListener(),!1)}),o.removeChild(t))}),a.classList.add("inputClosed"),a.classList.remove("waitEdit"),a.setAttribute("addr",n),J=!1}};i.inputListeners.push(d.addHandler(r,"focus",function(e){e=d.getEvent(e);e=d.getTarget(e).parentNode;X||j&&e.classList.contains("waitEdit")&&(W=e,F=null,e=r.getBoundingClientRect(),e.left,e.width,e.top,e.height)})),i.inputListeners.push(d.addHandler(r,"blur",function(e){e=d.getEvent(e);d.getTarget(e);s(r)})),i.inputListeners.push(d.addHandler(r,"keydown",function(e){e=d.getEvent(e);var t=d.getTarget(e),n=e.keyCode;d.stopPropagation(e);var i,e=r.selectionStart,t=t.value;switch(n){case 37:L(),0===l&&0===e&&a.previousSibling&&b(o,a,"forward");break;case 39:L(),l===t.length&&e===t.length&&a.nextSibling&&b(o,a,"backwards");break;case 8:u(r),0!==l||0!==e||(i=a.previousSibling)&&(i.className.split(" ").indexOf("selected")<0?(i.classList.add("selected"),$.push(i)):(G=G.filter(function(e){return e.id!==i||(e.removeAllListener(),!1)}),o.removeChild(i)));break;case 13:""!==t.trim()&&(s(r),h(o,a))}l=e}))}function h(e,t){var n,i=document.createElement("div"),r=new a(i,[],[]);G.push(r),"string"==typeof t?(i.className="item inputClosed",(n=document.createElement("span")).className="valueSpan draggable",n.innerHTML=t,i.append(n),i.setAttribute("addr",t),c(t)||(i.classList.add("error"),i.title="该地址格式有误，请双击修改"),f(i),e.appendChild(i)):(i.className="item waitEdit",n=document.createElement("input"),i.append(n),e.insertBefore(i,t?t.nextSibling:null),p(n),n.focus()),r.itemListeners.push(d.addHandler(i,"mouseenter",function(e){e=d.getEvent(e);d.getTarget(e);e=i.className.split(" ");-1<e.indexOf("inputClosed")&&e.indexOf("selected")<0&&i.classList.add("toActivate")})),r.itemListeners.push(d.addHandler(i,"mouseleave",function(e){e=d.getEvent(e);d.getTarget(e);i.classList.remove("toActivate")})),r.itemListeners.push(d.addHandler(i,"click",function(e){e=d.getEvent(e);d.getTarget(e);d.stopPropagation(e)})),r.itemListeners.push(d.addHandler(i,"mousedown",function(e){e=d.getEvent(e);d.getTarget(e);e=i.className.split(" ");-1<e.indexOf("inputClosed")&&e.indexOf("selected")<0&&(L(),i.classList.remove("toActivate"),i.classList.add("selected"),$.forEach(function(e,t,n){e!==i&&e.classList.remove("selected")}),$.push(i))})),r.itemListeners.push(d.addHandler(i,"dblclick",function(e){e=d.getEvent(e);var t;d.getTarget(e);d.stopPropagation(e),-1<i.className.split(" ").indexOf("inputClosed")&&(i.classList.remove("inputClosed"),$.forEach(function(e,t,n){e.classList.remove("selected")}),$=[],t=i.querySelector(".valueSpan"),(e=document.createElement("input")).value=t.innerHTML,i.replaceChild(e,t),u(e),p(e),e.focus(),i.removeAttribute("addr"),r.removeSeparatorListener(),i.removeChild(e.nextSibling))}))}function g(e){return e.getElementsByClassName("waitEdit")[0]}function v(e){var t=g(e);t&&e.removeChild(t)}function b(e,t,n){t&&t.querySelector("input")&&""!==t.querySelector("input").value.trim()&&t.classList.remove("waitEdit");var i=g(e);i||(h(e),i=g(e)),"forward"===n?e.insertBefore(i,t?t.previousSibling||t:null):"backwards"===n?e.insertBefore(i,t?t.nextSibling&&t.nextSibling.nextSibling:null):"before"===n?e.insertBefore(i,t||null):e.insertBefore(i,t?t.nextSibling:null),setTimeout(function(){i.querySelector("input").focus()})}function L(){X||($.forEach(function(e,t,n){e.classList.remove("selected")}),$=[])}function E(){var e=$[0],i=e.parentNode;b(i,e),$.forEach(function(t,e,n){G=G.filter(function(e){return e.id!==t||(e.removeAllListener(),!1)}),i.removeChild(t)}),$=[]}function y(e,t,n){function i(e){return cs=window.getComputedStyle?getComputedStyle(e,null):e.currentStyle,cs}var r=e.querySelectorAll(".inputClosed"),a=e.getBoundingClientRect(),o=i(e),l=a.top+Number(o.borderTop.split("px")[0])+Number(o.paddingTop.split("px")[0]),s=a.bottom-Number(o.borderBottom.split("px")[0])-Number(o.paddingBottom.split("px")[0]),d=a.left+Number(o.borderLeft.split("px")[0])+Number(o.paddingLeft.split("px")[0]),e=a.right-Number(o.borderRight.split("px")[0])-Number(o.paddingRight.split("px")[0]);t=e<t?e:t<d?d:t,n=n<l?l:s<n?s:n;for(var c=[],u=0,f=r.length;u<f;u++){var m=i(r[u]),p=r[u].getBoundingClientRect(),h=Number(m.marginTop.split("px")[0]),g=Number(m.marginBottom.split("px")[0]),m=p.top-h,h=p.bottom+g,g=p.left,p=p.right;if(n<=m){if(t<=g){c=0===u?[null,r[u]]:[r[u-1],r[u]];break}if(t<=p){c=[r[u]];break}if(!r[u+1]){c=[r[u],null];break}if(r[u+1].offsetTop>r[u].offsetTop){c=[r[u],r[u+1]];break}}else if(n<=h){if(t<=g){c=0===u?[null,r[u]]:[r[u-1],r[u]];break}if(t<=p){c=[r[u]];break}if(!r[u+1]){c=[r[u],null];break}if(r[u+1].offsetTop>r[u].offsetTop){c=[r[u],r[u+1]];break}}else if(u+1===f){c=[r[u],null];break}}a=W,e=(o=z).x,d=o.y,s=(l=a.getBoundingClientRect()).top,o=l.bottom,a=l.left,l=l.right,e=e=d<s?"top":o<d?"bottom":e<a?"left":l<e?"right":"middle";return 1===c.length?F=c[0]:"top"==e||"left"==e?F=c[1]:"right"!=e&&"bottom"!=e||(F=c[0]),{orien:e,rangEnd:F}}function x(e){e=d.getEvent(e);var t=d.getTarget(e);X||(t.classList.contains("_emailContainer")&&m(this.emailContainer,e.clientX,e.clientY),j=!0,(t=t.parentNode).classList.contains("waitEdit")&&(W=t,F=null),e.clientX,e.clientY)}function C(e){e=d.getEvent(e),d.preventDefault(e)}function N(e){var t,n;W&&(X||(n=e.event,e=R(t=e.target)&&D(t,"item"),t=W.parentNode,e&&e.parentNode===t?(F=e,z={x:n.clientX,y:n.clientY},O()):(z={x:n.clientX,y:n.clientY},n=y(t,n.clientX,n.clientY),F=n.rangEnd,O(n.orien))))}var w=null,H=0,S=0,T=10,A=40,k=document.documentElement||document.body;function B(e,n){var t=k.clientWidth,i=k.clientHeight;e.clientY<10||e.clientY>i-10||e.clientX<10||e.clientX>t-10?w||(H=e.clientY<10?e.clientY<3?A:T:e.clientY>i-10?e.clientY>i-7?-A:-T:0,S=e.clientX<10?e.clientX<3?A:T:e.clientX>t-10?e.clientX>t-7?-A:-T:0,w=setInterval(function(){var e=k.scrollTop,t=k.scrollLeft;0<=e&&e+i<k.offsetHeight&&(k.scrollTop=e-H),0<=t&&t+i<k.offsetWidth&&(k.scrollLeft=t-S),n&&n()},100)):I()}function I(){w&&(clearInterval(w),w=null)}function O(e){if(L(),W&&F){var t=W,n=F,i=W.parentNode.querySelectorAll(".item");if(e)if("top"===e||"left"===e){if(!W.previousSibling)return;t=F,n=W;var r=Array.prototype.indexOf.call(i,t);if(Array.prototype.indexOf.call(i,n)<r)return}else{if("right"!==e&&"bottom"!==e)return;if(!W.nextSibling)return;r=Array.prototype.indexOf.call(i,t);if(Array.prototype.indexOf.call(i,n)<r)return}else{r=Array.prototype.indexOf.call(i,W);Array.prototype.indexOf.call(i,F)<r&&(t=F,n=W)}function a(e){e&&e.classList.contains("inputClosed")&&(e.classList.add("selected"),$.push(e))}for(a(t);t&&t!==n;)a(t=t.nextSibling)}}d.addHandler(document,"mousemove",function(e){e=d.getEvent(e);var t=d.getTarget(e);W&&(X||(B(e,function(){Y(N,{event:e,target:t})}),Y(N,{event:e,target:t})))}),d.addHandler(document,"mouseup",function(e){e=d.getEvent(e);d.getTarget(e);I(),j=!1,W=null,X||$.length&&q()}),d.addHandler(document,"mousedown",function(e){e=d.getEvent(e);e=d.getTarget(e);e.classList&&e.classList.contains("selected")&&R(e)||e.parentNode&&e.parentNode.classList&&e.parentNode.classList.contains("selected")&&R(e.parentNode)||L()}),d.addHandler(document,"keydown",function(e){e=d.getEvent(e);d.getTarget(e);var t=e.keyCode;if(!($.length<1)){e=$[0].parentNode;switch(t){case 37:b(e,$[0],"before"),L();break;case 39:b(e,$[0]),L();break;case 8:case 46:E()}}}),l.enable();var M,X=!1;function Y(e,t){clearTimeout(e.tId),e.tId=setTimeout(function(){e(t)},10)}function q(){var e;!document.hasFocus()||(e=document.activeElement)&&e.blur()}function R(t){return!!(t=D(t,"_emailContainer"))&&V.some(function(e){return e===t})}function D(e,t){for(;e&&!e.classList||e&&e.classList&&!e.classList.contains(t);)e=e.parentNode;return e}function P(e){var t,n,i=e.event,r=i.referEl;-1<r.className.indexOf("_emailContainer")&&R(r)?m(t=r,i.clientX,i.clientY):(-1<r.className.indexOf("draggable")||-1<r.className.indexOf("semicolon"))&&R(r)?(t=(r=r.parentNode).parentNode,n=r.clientWidth,e=r.offsetLeft,i.clientX<=e+n/2?b(t,r,"before"):b(t,r)):R(D(r,"waitEdit"))||q()}function _(){this.emailIMEBox.className="emailIME-box",this.eLabel.className="eLabel",this.eLabel.innerHTML=this.label+"："||"",this.emailContainer.className="_emailContainer",this.emailIMEBox.appendChild(this.eLabel),this.emailIMEBox.appendChild(this.emailContainer),this.parentNode.appendChild(this.emailIMEBox),document.body.appendChild(K),function(){var e=this.emailContainer;d.addHandler(e,"mousedown",x.bind(this)),d.addHandler(this.emailContainer,"contextmenu",C)}.call(this),this.addAddrs(this.emailAddrList)}l.addHandler("dragstart",function(e){v(e.target.parentNode),X=!0}),l.addHandler("drag",function(e){B(e,function(){Y(P,{event:e})}),Y(P,{event:e})}),l.addHandler("dragend",function(e){function t(){var e=(e=null,document.hasFocus()&&(e=D(document.activeElement,"waitEdit")),R(e)&&e);if(e&&e.parentNode===r){for(var t=document.createDocumentFragment(),n=0,i=$.length;n<i;n++)t.appendChild($[n]);!function(e,n){for(var t=e.childNodes,i=0,r=n.length;i<r;i++)t.forEach(function(t){t.getAttribute("addr")===n[i].getAttribute("addr")&&(G=G.filter(function(e){return e.id!==t||(e.removeAllListener(),!1)}),e.removeChild(t))})}(r,t.childNodes),r.insertBefore(t,e),q()}else console.warn("cursor disappeared.")}var r;-1<(M=e.referEl).className.indexOf("_emailContainer")&&R(M)?(r=M,t()):(-1<M.className.indexOf("draggable")||-1<M.className.indexOf("semicolon"))&&R(M)?(M=M.parentNode,r=M.parentNode,(M.classList.contains("selected")?q:t)()):R(D(M,"waitEdit"))?(r=D(M,"_emailContainer"),t()):q(),X=!1});var j,W,F,z,V=[],$=[],G=new r,J=!1,K=document.createElement("div");function Q(e,t,n){if(!(this instanceof Q))return new Q(e,t,n);this.parentNode=e||document.body,this.label=t,this.emailAddrList=n,this.emailIMEBox=document.createElement("div"),this.eLabel=document.createElement("label"),this.emailContainer=document.createElement("div"),V.push(this.emailContainer),_.call(this)}return K.className="width_calculator",Q.prototype={constructor:Q,addAddrs:function(e){if(e){"[object Array]"!==Object.prototype.toString.call(e)&&(e=[e]),e=(e=e.filter(function(e){return""!==e&&void 0!==e})).map(function(e){return e.toString()});var t=[];t.push(e[0]);for(var n=1,i=e.length;n<i;n++){for(var r=!1,a=0;a<t.length;a++)if(e[n]===t[a]){r=!0;break}r||t.push(e[n])}var o=this;t.forEach(function(e){h(o.emailContainer,e)}),v(this.emailContainer)}else b(this.emailContainer)},getAddrs:function(){var t=[],e=this.emailContainer.getElementsByClassName("item inputClosed");return Array.prototype.forEach.call(e,function(e){t.push(e.getAttribute("addr"))}),t},destroy:function(){I();var e=this.emailContainer.getElementsByClassName("item");Array.prototype.forEach.call(e,function(t){G=G.filter(function(e){return e.id!==t||(e.removeAllListener(),!1)})}),e=this.emailContainer,d.removeHandler(e,"mousedown",x),d.removeHandler(e,"contextmenu",C),V=V.filter(function(e){return e!==this.emailContainer}),this.parentNode.removeChild(this.emailIMEBox)}},window.emailIME||(window.emailIME=Q),Q});